<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IT Onboarding Assistant - Manager</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; }
    .navbar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .card { border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <a class="navbar-brand" href="#"><i class="fas fa-users-cog me-2"></i>IT Onboarding Manager</a>
      <div class="navbar-nav ms-auto">
        <span class="navbar-text me-3">
          <i class="fas fa-user me-1"></i>
          Welcome, <span id="username"></span> (<span id="userRole"></span>)
        </span>
        <button class="btn btn-outline-light btn-sm" onclick="logout()">
          <i class="fas fa-sign-out-alt me-1"></i>Logout
        </button>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <!-- Metrics Dashboard -->
    <div class="row mb-3">
      <div class="col-md-3">
        <div class="card text-center p-3">
          <h5>Total Checklists</h5>
          <h2 id="metricTotalChecklists">0</h2>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center p-3">
          <h5>Completed Tasks</h5>
          <h2 id="metricCompletedTasks">0</h2>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center p-3">
          <h5>In Progress</h5>
          <h2 id="metricInProgress">0</h2>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center p-3">
          <h5>Ignored Tasks</h5>
          <h2 id="metricIgnoredTasks">0</h2>
        </div>
      </div>
    </div>

    <!-- Workflow Management -->
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">
        <h5><i class="fas fa-sitemap me-2"></i>Manage Workflows</h5>
      </div>
      <div class="card-body">
        <div id="publishInfo" class="alert alert-info small py-2 mb-3" style="display:none;"></div>

        <select id="licenseSelect" class="form-select mb-3">
          <option value="F1">F1 License</option>
          <option value="F3">F3 License</option>
          <option value="E3">E3 License</option>
        </select>

        <table class="table table-bordered table-striped">
          <thead class="table-light">
            <tr>
              <th>Task Name</th>
              <th>Category</th>
              <th>Mandatory</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="workflowTasks">
            <tr><td colspan="4" class="text-muted text-center">No tasks yet</td></tr>
          </tbody>
        </table>

        <!-- Add Task -->
        <div class="input-group mb-2">
          <input type="text" id="newTaskName" class="form-control" placeholder="New Task Name">
          <select id="newTaskCategory" class="form-select">
            <option>Account Setup</option>
            <option>Email Setup</option>
            <option>Security</option>
            <option>Software</option>
            <option>Network</option>
            <option>Documentation</option>
            <option>Collaboration</option>
            <option>Analytics</option>
            <option>Mobile</option>
            <option>Compliance</option>
          </select>
          <select id="newTaskMandatory" class="form-select">
            <option value="true">Mandatory</option>
            <option value="false">Optional</option>
          </select>
          <button class="btn btn-success" onclick="addTask()"><i class="fas fa-plus"></i></button>
        </div>

        <button class="btn btn-primary" onclick="saveWorkflow()"><i class="fas fa-upload me-1"></i>Publish Workflow</button>
      </div>
    </div>

    <!-- Checklists Overview -->
    <div class="card">
      <div class="card-header bg-info text-white">
        <h5><i class="fas fa-list me-2"></i>All Checklists</h5>
      </div>
      <div class="card-body">
        <table class="table table-bordered table-striped" id="checklistsTable">
          <thead class="table-light">
            <tr>
              <th>Checklist Name</th>
              <th>License</th>
              <th>Owner</th>
              <th>Total Tasks</th>
              <th>Completed</th>
            </tr>
          </thead>
          <tbody id="checklistsBody">
            <tr><td colspan="5" class="text-muted text-center">No checklists yet</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
  <script>
    let currentUser = null;

    // Load workflows from localStorage (published ones) or fallback
    let workflows = JSON.parse(localStorage.getItem("workflows"));
    if (!workflows) {
      workflows = { "F1": [], "F3": [], "E3": [] };
    } else {
      ["F1", "F3", "E3"].forEach(lic => {
        if (!workflows[lic]) workflows[lic] = [];
      });
    }

    window.onload = function() {
      const userData = localStorage.getItem('currentUser');
      if (!userData) { window.location.href = 'index.html'; return; }
      currentUser = JSON.parse(userData);
      if (currentUser.role !== "IT Manager") { window.location.href = 'dashboard.html'; return; }
      document.getElementById("username").textContent = currentUser.username;
      document.getElementById("userRole").textContent = currentUser.role;

      renderWorkflow();
      renderChecklists();
      updateMetrics();
      showPublishInfo();
    };

    // --- Workflow Management ---
    function renderWorkflow() {
      const license = document.getElementById("licenseSelect").value;
      const tasks = workflows[license];
      const tbody = document.getElementById("workflowTasks");
      tbody.innerHTML = "";

      if (tasks.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" class="text-muted text-center">No tasks yet</td></tr>`;
        return;
      }

      tasks.forEach((task, i) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${task.name}</td>
          <td>${task.category}</td>
          <td>${task.mandatory ? "Yes" : "No"}</td>
          <td>
            <button class="btn btn-sm btn-warning me-1" onclick="editTask(${i})"><i class="fas fa-edit"></i></button>
            <button class="btn btn-sm btn-danger" onclick="deleteTask(${i})"><i class="fas fa-trash"></i></button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function addTask() {
      const license = document.getElementById("licenseSelect").value;
      const name = document.getElementById("newTaskName").value.trim();
      const category = document.getElementById("newTaskCategory").value;
      const mandatory = document.getElementById("newTaskMandatory").value === "true";
      if (!name) return alert("Task name required");
      workflows[license].push({ id: Date.now(), name, category, mandatory });
      document.getElementById("newTaskName").value = "";
      renderWorkflow();
      logAudit(`Added task "${name}" to ${license} workflow`);
    }

    function editTask(index) {
      const license = document.getElementById("licenseSelect").value;
      const task = workflows[license][index];
      const tbody = document.getElementById("workflowTasks");
      const row = tbody.rows[index];
      row.innerHTML = `
        <td><input type="text" class="form-control form-control-sm" id="editName" value="${task.name}"></td>
        <td>
          <select id="editCategory" class="form-select form-select-sm">
            <option ${task.category === "Account Setup" ? "selected" : ""}>Account Setup</option>
            <option ${task.category === "Email Setup" ? "selected" : ""}>Email Setup</option>
            <option ${task.category === "Security" ? "selected" : ""}>Security</option>
            <option ${task.category === "Software" ? "selected" : ""}>Software</option>
            <option ${task.category === "Network" ? "selected" : ""}>Network</option>
            <option ${task.category === "Documentation" ? "selected" : ""}>Documentation</option>
            <option ${task.category === "Collaboration" ? "selected" : ""}>Collaboration</option>
            <option ${task.category === "Analytics" ? "selected" : ""}>Analytics</option>
            <option ${task.category === "Mobile" ? "selected" : ""}>Mobile</option>
            <option ${task.category === "Compliance" ? "selected" : ""}>Compliance</option>
          </select>
        </td>
        <td>
          <select id="editMandatory" class="form-select form-select-sm">
            <option value="true" ${task.mandatory ? "selected" : ""}>Yes</option>
            <option value="false" ${!task.mandatory ? "selected" : ""}>No</option>
          </select>
        </td>
        <td>
          <button class="btn btn-sm btn-success me-1" onclick="saveTaskEdit(${index})"><i class="fas fa-check"></i></button>
          <button class="btn btn-sm btn-secondary" onclick="renderWorkflow()"><i class="fas fa-times"></i></button>
        </td>
      `;
    }

    function saveTaskEdit(index) {
      const license = document.getElementById("licenseSelect").value;
      const name = document.getElementById("editName").value.trim();
      const category = document.getElementById("editCategory").value;
      const mandatory = document.getElementById("editMandatory").value === "true";
      if (!name) return alert("Task name cannot be empty");
      workflows[license][index] = { ...workflows[license][index], name, category, mandatory };
      renderWorkflow();
      logAudit(`Edited task "${name}" in ${license} workflow`);
    }

    function deleteTask(index) {
      const license = document.getElementById("licenseSelect").value;
      const task = workflows[license][index];
      workflows[license].splice(index, 1);
      renderWorkflow();
      logAudit(`Deleted task "${task.name}" from ${license} workflow`);
    }

    function saveWorkflow() {
      localStorage.setItem("workflows", JSON.stringify(workflows));
      localStorage.setItem("workflows_lastUpdated", new Date().toLocaleString());
      alert("Workflow published successfully!");
      showPublishInfo();
      logAudit("Published workflow updates");
    }

    function showPublishInfo() {
      const info = document.getElementById("publishInfo");
      const lastUpdated = localStorage.getItem("workflows_lastUpdated");
      if (lastUpdated) {
        info.textContent = `You are editing the published workflows (last updated: ${lastUpdated})`;
        info.style.display = "block";
      }
    }

    // --- Checklists ---
    function renderChecklists() {
      const tbody = document.getElementById("checklistsBody");
      tbody.innerHTML = "";
      let total = 0;
      for (let key in localStorage) {
        if (key.startsWith("checklists_")) {
          const lists = JSON.parse(localStorage.getItem(key));
          lists.forEach(c => {
            total++;
            const completed = c.tasks.filter(t => t.status === "completed").length;
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${c.name}</td>
              <td>${c.license}</td>
              <td>${key.replace("checklists_", "")}</td>
              <td>${c.tasks.length}</td>
              <td>${completed}</td>
            `;
            tbody.appendChild(row);
          });
        }
      }
      if (total === 0) {
        tbody.innerHTML = `<tr><td colspan="5" class="text-muted text-center">No checklists yet</td></tr>`;
      }
    }

    // --- Metrics ---
    function updateMetrics() {
      let totalChecklists = 0, completed = 0, ignored = 0, inProgress = 0;
      for (let key in localStorage) {
        if (key.startsWith("checklists_")) {
          const lists = JSON.parse(localStorage.getItem(key));
          lists.forEach(c => {
            totalChecklists++;
            completed += c.tasks.filter(t => t.status === "completed").length;
            ignored += c.tasks.filter(t => t.status === "ignored").length;
            inProgress += c.tasks.filter(t => t.status === "pending").length;
          });
        }
      }
      document.getElementById("metricTotalChecklists").textContent = totalChecklists;
      document.getElementById("metricCompletedTasks").textContent = completed;
      document.getElementById("metricIgnoredTasks").textContent = ignored;
      document.getElementById("metricInProgress").textContent = inProgress;
    }

    // --- Audit Logging ---
    function logAudit(message) {
      const config = JSON.parse(localStorage.getItem("systemConfig")) || { auditLogs: true };
      if (!config.auditLogs) return;
      const currentUser = JSON.parse(localStorage.getItem("currentUser"));
      if (!currentUser) return;
      const logs = JSON.parse(localStorage.getItem("auditLogs")) || [];
      logs.push({
        user: currentUser.username,
        role: currentUser.role,
        message,
        time: new Date().toLocaleString()
      });
      localStorage.setItem("auditLogs", JSON.stringify(logs));
    }

    // --- Misc ---
    function logout() {
      localStorage.removeItem("currentUser");
      window.location.href = "index.html";
    }

    document.getElementById("licenseSelect").addEventListener("change", renderWorkflow);
  </script>
</body>
</html>
