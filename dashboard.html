<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Onboarding Assistant - Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .license-card {
            cursor: pointer;
            min-height: 100px;
        }
        .license-card.selected {
            border: 3px solid #667eea;
            background: linear-gradient(135deg, #e8f0ff 0%, #f0e8ff 100%);
        }
        .progress-circle {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px auto;
            font-weight: bold;
            font-size: 0.95rem;
        }
        .task-item {
            border-left: 4px solid #dee2e6;
            transition: all 0.3s;
            padding: 6px 8px !important;
            font-size: 0.9rem;
        }
        .task-item.completed {
            border-left-color: #28a745;
            background-color: #f8fff9;
        }
        .task-item.ignored {
            border-left-color: #ffc107;
            background-color: #fffdf0;
        }
        .btn-task, .btn, .btn-sm, .btn-light, .btn-success, .btn-outline-primary, .btn-outline-secondary, .btn-outline-success, .btn-outline-warning, .btn-outline-light, .btn-warning {
            padding: 2px 7px !important;
            font-size: 0.75rem !important;
            border-radius: 12px !important;
            margin-bottom: 1px;
        }
        .workflow-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 10px;
            overflow-x: auto;
        }
        .workflow-step {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 6px;
            margin: 3px;
            text-align: center;
            min-width: 90px;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
            transition: transform 0.3s;
            font-size: 0.8rem;
        }
        .workflow-step:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 7px rgba(0,0,0,0.12);
        }
        .workflow-step.mandatory {
            border-color: #dc3545;
            background: linear-gradient(135deg, #fff5f5 0%, #ffe6e6 100%);
        }
        .workflow-step.optional {
            border-color: #28a745;
            background: linear-gradient(135deg, #f8fff9 0%, #e6ffe6 100%);
        }
        .workflow-arrow {
            font-size: 15px;
            color: #6c757d;
            margin: 4px 0;
        }
        .workflow-flow {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }
        .category-section {
            margin: 4px 0;
            padding: 5px;
            background: white;
            border-radius: 10px;
            border-left: 3px solid #007bff;
        }
        @keyframes blink {
            0% { box-shadow: 0 0 0 0 #ffc107; }
            50% { box-shadow: 0 0 10px 4px #ffc107; }
            100% { box-shadow: 0 0 0 0 #ffc107; }
        }
        .btn-blink {
            animation: blink 1s infinite;
            border: 2px solid #ffc107 !important;
        }
        .step-header {
            cursor: pointer;
            user-select: none;
        }
        .step-header .fa-chevron-down,
        .step-header .fa-chevron-up {
            transition: transform 0.2s;
        }
        /* Progress horizontal list */
        .progress-horizontal-list {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 6px;
            font-size: 0.85rem;
        }
        .progress-horizontal-list .progress-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 2px 7px;
            min-width: 60px;
            text-align: center;
        }
        /* Saved checklist compact */
        #savedChecklists {
            padding: 0;
        }
        .saved-checklist-item {
            font-size: 0.8rem;
            padding: 4px 6px;
            margin-bottom: 3px;
            border-radius: 7px;
            border: 1px solid #e0e0e0;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .saved-checklist-item .btn {
            padding: 1px 6px !important;
            font-size: 0.75rem !important;
        }
        /* Collapsible saved checklist */
        #savedChecklistCollapse {
            transition: max-height 0.3s;
            overflow: hidden;
        }
        /* Responsive: fit all in one screen */
        @media (max-width: 991px) {
            #step3-tasks-progress {
                flex-direction: column !important;
            }
            #step3-tasks-col, #step3-progress-col {
                max-width: 100% !important;
                flex: 0 0 100% !important;
            }
        }
        @media (min-width: 992px) {
            #step3-tasks-progress {
                display: flex;
                flex-wrap: nowrap;
                gap: 10px;
            }
            #step3-tasks-col {
                flex: 0 0 60%;
                max-width: 60%;
            }
            #step3-progress-col {
                flex: 0 0 40%;
                max-width: 40%;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-users-cog me-2"></i>IT Onboarding Assistant
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">
                    <i class="fas fa-user me-1"></i>
                    Welcome, <span id="username"></span> (<span id="userRole"></span>)
                </span>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">
                    <i class="fas fa-sign-out-alt me-1"></i>Logout
                </button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
     <div class="row mb-3">
    <div class="col-12">
        <div class="alert alert-info shadow-sm" role="alert" style="font-size:1.05rem;">
            <strong>Welcome to the IT Onboarding Assistant!</strong><br>
            <span style="color:#212529;">Onboarding Assistant makes an employee's first day at work easy. Follow just 3 steps!!</span>
            <br>
            <span style="color:#0d6efd; font-weight:600;">Choose a license type ðŸ‘¤</span>
            <span style="color:#0da8f0; font-weight:600;"> See the steps to follow ðŸªœ</span>
            <span style="color:#198754; font-weight:600;"> and Create a checklistâœ…</span>
            <span style="color:#212529;"> to track your progress until everything is done.</span>
        </div>
    </div>
</div>
        <!-- Step 1: License Selection -->
        <div id="step1" class="row">
            <div class="col-12">
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-license me-2"></i>Step 1: Select License Type</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-2">
                                <div class="card license-card h-100" onclick="selectLicense('F1', event)">
                                    <div class="card-body text-center">
                                        <i class="fas fa-user-tie fa-2x text-primary mb-2"></i>
                                        <h6>F1 License</h6>
                                        <p class="text-muted" style="font-size:0.85rem;">Basic User License<br>Standard onboarding tasks</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-2">
                                <div class="card license-card h-100" onclick="selectLicense('F3', event)">
                                    <div class="card-body text-center">
                                        <i class="fas fa-user-cog fa-2x text-success mb-2"></i>
                                        <h6>F3 License</h6>
                                        <p class="text-muted" style="font-size:0.85rem;">Advanced User License<br>Enhanced features setup</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-2">
                                <div class="card license-card h-100" onclick="selectLicense('E3', event)">
                                    <div class="card-body text-center">
                                        <i class="fas fa-user-shield fa-2x text-warning mb-2"></i>
                                        <h6>E3 License</h6>
                                        <p class="text-muted" style="font-size:0.85rem;">Enterprise License<br>Full feature access</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: View Workflow (Collapsible) -->
        <div id="step2" class="row" style="display: none;">
            <div class="col-12">
                <div class="card mb-3">
                    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center step-header" onclick="toggleStep('step2')">
                        <h5 class="mb-0">
                            <i class="fas fa-sitemap me-2"></i>Step 2: Review Workflow - <span id="selectedLicenseTitle"></span>
                        </h5>
                        <span>
                            <i id="step2-chevron" class="fas fa-chevron-down"></i>
                        </span>
                    </div>
                    <div class="collapse show" id="step2-content">
                        <div class="card-body">
                            <div class="d-flex align-items-center justify-content-between mb-3">
        <p class="lead mb-0 fw-semibold" style="font-size:1.08rem; color:#0d6efd;">
    <i class="fas fa-route me-2 text-info"></i>
    <span style="letter-spacing:0.5px;">
        Explore the onboarding journey for this license type and see every step at a glance!
    </span>
</p>
        <button id="proceedChecklistBtn" class="btn btn-light btn-sm btn-blink" onclick="proceedToChecklist()">
            <i class="fas fa-arrow-right me-1"></i>Create Checklist
        </button>
    </div>
    <div id="workflowChart" class="workflow-container">
                                <!-- Flowchart will be generated here -->
                            </div>
                            
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 3: Checklist Creation (Collapsible) -->
        <div id="step3" class="row" style="display: none;">
            <div class="col-12">
                <div class="card mb-3">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center step-header" onclick="toggleStep('step3')">
                        <h5 class="mb-0"><i class="fas fa-list me-2"></i>Step 3: Create Checklist</h5>
                        <span>
                            <i id="step3-chevron" class="fas fa-chevron-down"></i>
                        </span>
                    </div>
                    <div class="collapse" id="step3-content">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <label for="checklistName" class="form-label">Checklist Name:</label>
                                    <input type="text" class="form-control form-control-sm" id="checklistName" 
                                           placeholder="Enter your Checklist name">
                                </div>
                                <div class="col-md-4 d-flex align-items-end">
                                    <button class="btn btn-success btn-sm" onclick="createChecklist()">
                                        <i class="fas fa-plus me-2"></i>Create Checklist
                                    </button>
                                </div>
                            </div>
                            <!-- Progress and tasks side by side -->
                            <div class="row mt-2" id="step3-tasks-progress" style="display:none;">
                                <div class="col-lg-7 col-md-7 col-12" id="step3-tasks-col" style="padding-right:0;">
                                    <div class="card h-100">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0"><i class="fas fa-tasks me-2"></i>Onboarding Tasks</h6>
                                            <div>
                                                <button class="btn btn-outline-primary btn-sm me-1" onclick="saveProgressAndShowSaved()">
                                                    <i class="fas fa-save me-1"></i>Save Progress
                                                </button>
                                                <button class="btn btn-outline-secondary btn-sm" onclick="resetChecklist()">
                                                    <i class="fas fa-redo me-1"></i>New Checklist
                                                </button>
                                            </div>
                                        </div>
                                        <div class="card-body" style="padding:8px;">
                                            <div id="tasksList"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-5 col-md-5 col-12" id="step3-progress-col" style="padding-left:6px;">
                                    <div class="card h-100">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Progress</h6>
                                            <button class="btn btn-outline-info btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#savedChecklistCollapse" aria-expanded="true" aria-controls="savedChecklistCollapse" id="toggleSavedBtn">
                                                <i class="fas fa-list"></i>
                                                <span class="ms-1">View Saved Checklists</span>
                                            </button>
                                        </div>
                                        <div class="card-body text-center" style="padding:8px;">
                                            <div class="progress-circle bg-light mb-1" id="progressCircle">
                                                0%
                                            </div>
                                            <div class="progress-horizontal-list mb-2">
                                                <div class="progress-item"><strong>Checklist</strong><br><span id="currentChecklistName">-</span></div>
                                                <div class="progress-item"><strong>License</strong><br><span id="currentLicense">-</span></div>
                                                <div class="progress-item"><strong>Done</strong><br><span id="completedTasks">0</span></div>
                                                <div class="progress-item"><strong>Total</strong><br><span id="totalTasks">0</span></div>
                                                <div class="progress-item"><strong>Ignored</strong><br><span id="ignoredTasks">0</span></div>
                                            </div>
                                            <div class="collapse show" id="savedChecklistCollapse">
                                                <div id="savedChecklists" class="mt-2"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div><!-- card-body -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 4: Task Management (unchanged) -->
        <div id="step4" class="row" style="display: none;">
            <div class="col-md-8">
               
            </div>
            
           
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // License workflows with tasks
        const workflows = {
            'F1': [
                { id: 1, name: 'Create Active Directory Account', category: 'Account Setup', mandatory: true },
                { id: 2, name: 'Assign Basic Email License', category: 'Email Setup', mandatory: true },
                { id: 3, name: 'Add to Security Groups', category: 'Security', mandatory: true },
                { id: 4, name: 'Install Office 365 Apps', category: 'Software', mandatory: true },
                { id: 5, name: 'Configure VPN Access', category: 'Network', mandatory: false },
                { id: 6, name: 'Setup Desktop Profile', category: 'Configuration', mandatory: true },
                { id: 7, name: 'Verify Email Connectivity', category: 'Testing', mandatory: true },
                { id: 8, name: 'Document Account Details', category: 'Documentation', mandatory: true }
            ],
            'F3': [
                { id: 1, name: 'Create Active Directory Account', category: 'Account Setup', mandatory: true },
                { id: 2, name: 'Assign F3 Email License', category: 'Email Setup', mandatory: true },
                { id: 3, name: 'Add to Advanced Security Groups', category: 'Security', mandatory: true },
                { id: 4, name: 'Install Office 365 Pro Plus', category: 'Software', mandatory: true },
                { id: 5, name: 'Configure Advanced VPN Access', category: 'Network', mandatory: true },
                { id: 6, name: 'Setup Teams and SharePoint Access', category: 'Collaboration', mandatory: true },
                { id: 7, name: 'Enable Multi-Factor Authentication', category: 'Security', mandatory: true },
                { id: 8, name: 'Configure PowerBI Access', category: 'Analytics', mandatory: false },
                { id: 9, name: 'Setup Mobile Device Management', category: 'Mobile', mandatory: false },
                { id: 10, name: 'Verify All Services', category: 'Testing', mandatory: true },
                { id: 11, name: 'Document Account Details', category: 'Documentation', mandatory: true }
            ],
            'E3': [
                { id: 1, name: 'Create Active Directory Account', category: 'Account Setup', mandatory: true },
                { id: 2, name: 'Assign E3 Enterprise License', category: 'Email Setup', mandatory: true },
                { id: 3, name: 'Add to Enterprise Security Groups', category: 'Security', mandatory: true },
                { id: 4, name: 'Install Full Office Suite', category: 'Software', mandatory: true },
                { id: 5, name: 'Configure Enterprise VPN Access', category: 'Network', mandatory: true },
                { id: 6, name: 'Setup Advanced Teams Features', category: 'Collaboration', mandatory: true },
                { id: 7, name: 'Enable Advanced Security Features', category: 'Security', mandatory: true },
                { id: 8, name: 'Configure PowerBI Premium', category: 'Analytics', mandatory: true },
                { id: 9, name: 'Setup Advanced Compliance', category: 'Compliance', mandatory: true },
                { id: 10, name: 'Configure Enterprise Mobile Management', category: 'Mobile', mandatory: true },
                { id: 11, name: 'Setup Advanced Exchange Features', category: 'Email', mandatory: false },
                { id: 12, name: 'Configure Enterprise Voice', category: 'Communication', mandatory: false },
                { id: 13, name: 'Setup Advanced Analytics', category: 'Analytics', mandatory: false },
                { id: 14, name: 'Verify All Enterprise Services', category: 'Testing', mandatory: true },
                { id: 15, name: 'Document Enterprise Account', category: 'Documentation', mandatory: true }
            ]
        };

        let currentUser = null;
        let selectedLicense = null;
        let currentChecklist = null;

        window.onload = function() {
            const userData = localStorage.getItem('currentUser');
            if (!userData) {
                window.location.href = 'index.html';
                return;
            }
            currentUser = JSON.parse(userData);
            document.getElementById('username').textContent = currentUser.username;
            document.getElementById('userRole').textContent = currentUser.role;
            loadSavedChecklists();
            
        };

        function selectLicense(license, event) {
            document.querySelectorAll('.license-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            selectedLicense = license;
            document.getElementById('selectedLicenseTitle').textContent = license + ' License';
            generateWorkflowChart(license);
            document.getElementById('step2').style.display = 'block';
            document.getElementById('step2-content').classList.add('show');
            document.getElementById('step3').style.display = 'none';
            document.getElementById('step4').style.display = 'none';
            document.getElementById('step3-tasks-progress').style.display = 'none';
            document.getElementById('step2').scrollIntoView({ behavior: 'smooth' });
        }

        function generateWorkflowChart(license) {
    const tasks = workflows[license];
    const chartContainer = document.getElementById('workflowChart');
    const categories = {};
    tasks.forEach(task => {
        if (!categories[task.category]) {
            categories[task.category] = [];
        }
        categories[task.category].push(task);
    });

    // Calculate stats
    const mandatoryCount = tasks.filter(t => t.mandatory).length;
    const optionalCount = tasks.filter(t => !t.mandatory).length;

    // Start chartHTML with the stats row at the top
    let chartHTML = `
        <div class="row mb-2">
            <div class="col-4">
                <div class="text-center p-1 bg-light rounded">
                    <div class="text-primary mb-0" style="font-size:1.1rem;">${tasks.length}</div>
                    <small>Total Tasks</small>
                </div>
            </div>
            <div class="col-4">
                <div class="text-center p-1 bg-light rounded">
                    <div class="text-danger mb-0" style="font-size:1.1rem;">${mandatoryCount}</div>
                    <small>Required</small>
                </div>
            </div>
            <div class="col-4">
                <div class="text-center p-1 bg-light rounded">
                    <div class="text-success mb-0" style="font-size:1.1rem;">${optionalCount}</div>
                    <small>Optional</small>
                </div>
            </div>
        </div>
    `;

    chartHTML += '<div class="workflow-flow">';
    // START block with arrow below
    chartHTML += `
        <div style="display: flex; flex-direction: column; align-items: center;">
            <div class="workflow-step" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; border-color: #28a745;">
                <i class="fas fa-play fa-lg mb-1"></i>
                <div style="font-size:0.9rem;">START</div>
                <small>Begin ${license} Onboarding</small>
            </div>
            <div class="workflow-arrow" style="margin:0;"><i class="fas fa-arrow-down"></i></div>
        </div>
    `;
    const categoryKeys = Object.keys(categories);
    categoryKeys.forEach((category, index) => {
        const categoryTasks = categories[category];
        chartHTML += `
            <div class="category-section w-100">
                <div class="text-primary mb-2" style="font-size:0.95rem;">
                    <i class="fas fa-folder me-2"></i>${category}
                </div>
                <div class="d-flex flex-wrap justify-content-center">
        `;
        categoryTasks.forEach((task, taskIndex) => {
            const isLast = taskIndex === categoryTasks.length - 1;
            chartHTML += `
                <div class="workflow-step ${task.mandatory ? 'mandatory' : 'optional'}">
                    <i class="fas ${getTaskIcon(task.category)} fa-sm mb-1 ${task.mandatory ? 'text-danger' : 'text-success'}"></i>
                    <div class="mb-1" style="font-size:0.9rem;">${task.name}</div>
                    <small class="text-muted">${task.mandatory ? 'Required' : 'Optional'}</small>
                </div>
                ${!isLast ? '<div class="workflow-arrow"><i class="fas fa-arrow-right"></i></div>' : ''}
            `;
        });
        chartHTML += `
                </div>
            </div>
        `;
        if (index < categoryKeys.length - 1) {
            chartHTML += '<div class="workflow-arrow w-100 text-center"><i class="fas fa-arrow-down"></i></div>';
        }
    });
    // Arrow above COMPLETE button, then COMPLETE button
    chartHTML += `
        <div style="display: flex; flex-direction: column; align-items: center;">
            <div class="workflow-arrow" style="margin:0;"><i class="fas fa-arrow-down"></i></div>
            <div class="workflow-step" style="background: linear-gradient(135deg, #dc3545, #e74c3c); color: white; border-color: #dc3545;">
                <i class="fas fa-check-circle fa-lg mb-1"></i>
                <div style="font-size:0.9rem;">COMPLETE</div>
                <small>${license} Onboarding Finished</small>
            </div>
        </div>
    `;
    chartHTML += '</div>';

    chartContainer.innerHTML = chartHTML;
}

        function getTaskIcon(category) {
            const icons = {
                'Account Setup': 'fa-user-plus',
                'Email Setup': 'fa-envelope',
                'Security': 'fa-shield-alt',
                'Software': 'fa-download',
                'Network': 'fa-network-wired',
                'Configuration': 'fa-cogs',
                'Testing': 'fa-vial',
                'Documentation': 'fa-file-alt',
                'Collaboration': 'fa-users',
                'Analytics': 'fa-chart-bar',
                'Mobile': 'fa-mobile-alt',
                'Compliance': 'fa-clipboard-check',
                'Email': 'fa-at',
                'Communication': 'fa-phone'
            };
            return icons[category] || 'fa-tasks';
        }

        function toggleStep(stepId) {
            if (stepId === 'step2') {
                const content = document.getElementById('step2-content');
                const chevron = document.getElementById('step2-chevron');
                if (content.classList.contains('show')) {
                    content.classList.remove('show');
                    chevron.classList.remove('fa-chevron-down');
                    chevron.classList.add('fa-chevron-up');
                } else {
                    content.classList.add('show');
                    chevron.classList.remove('fa-chevron-up');
                    chevron.classList.add('fa-chevron-down');
                }
            } else if (stepId === 'step3') {
                const content = document.getElementById('step3-content');
                const chevron = document.getElementById('step3-chevron');
                if (content.classList.contains('show')) {
                    content.classList.remove('show');
                    chevron.classList.remove('fa-chevron-down');
                    chevron.classList.add('fa-chevron-up');
                } else {
                    content.classList.add('show');
                    chevron.classList.remove('fa-chevron-up');
                    chevron.classList.add('fa-chevron-down');
                }
            }
        }

        function proceedToChecklist() {
            document.getElementById('step2-content').classList.remove('show');
            document.getElementById('step3').style.display = 'block';
            document.getElementById('step3-content').classList.add('show');
            document.getElementById('step3-chevron').classList.remove('fa-chevron-up');
            document.getElementById('step3-chevron').classList.add('fa-chevron-down');
            document.getElementById('step3-tasks-progress').style.display = 'none';
            document.getElementById('savedChecklistCollapse').classList.remove('show');
            document.getElementById('step3').scrollIntoView({ behavior: 'smooth' });
        }

        function createChecklist() {
            const checklistName = document.getElementById('checklistName').value.trim();
            if (!checklistName) {
                alert('Please enter a checklist name');
                return;
            }
            if (!selectedLicense) {
                alert('Please select a license type first');
                return;
            }
            currentChecklist = {
                id: Date.now(),
                name: checklistName,
                license: selectedLicense,
                created: new Date().toISOString(),
                tasks: workflows[selectedLicense].map(task => ({
                    ...task,
                    status: 'pending',
                    completedAt: null,
                    notes: ''
                }))
            };
            document.getElementById('step3-tasks-progress').style.display = 'flex';
            renderTasks();
            updateProgress();
            document.getElementById('currentChecklistName').textContent = checklistName;
            document.getElementById('currentLicense').textContent = selectedLicense;
            document.getElementById('step3-tasks-progress').scrollIntoView({ behavior: 'smooth' });
            document.getElementById('savedChecklistCollapse').classList.remove('show');
            logAudit(`Created new checklist "${checklistName}" for license ${selectedLicense}`);
        }

        // Save progress and show saved checklist collapse
        function saveProgressAndShowSaved() {
            saveProgress();
            let collapse = document.getElementById('savedChecklistCollapse');
            if (!collapse.classList.contains('show')) {
                let bsCollapse = bootstrap.Collapse.getOrCreateInstance(collapse);
                bsCollapse.show();
            }
        }

        function renderTasks() {
            const tasksList = document.getElementById('tasksList');
            tasksList.innerHTML = '';
            currentChecklist.tasks.forEach(task => {
                const taskElement = document.createElement('div');
                taskElement.className = `task-item p-2 mb-1 rounded ${task.status}`;
                taskElement.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-grow-1">
                            <div class="mb-1" style="font-size:0.95rem;">${task.name}</div>
                            <small class="text-muted">
                                <i class="fas fa-tag me-1"></i>${task.category}
                                ${task.mandatory ? '<i class="fas fa-exclamation-circle text-danger ms-2" title="Mandatory"></i>' : '<i class="fas fa-info-circle text-info ms-2" title="Optional"></i>'}
                            </small>
                        </div>
                        <div class="task-actions">
                            ${task.status === 'pending' ? `
                                <button class="btn btn-success btn-task me-1" onclick="completeTask(${task.id})">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn btn-warning btn-task" onclick="ignoreTask(${task.id})">
                                    <i class="fas fa-times"></i>
                                </button>
                            ` : task.status === 'completed' ? `
                                <button class="btn btn-outline-success btn-task me-1" disabled>
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn btn-outline-secondary btn-task" onclick="resetTask(${task.id})">
                                    <i class="fas fa-undo"></i>
                                </button>
                            ` : `
                                <button class="btn btn-outline-warning btn-task me-1" disabled>
                                    <i class="fas fa-times"></i>
                                </button>
                                <button class="btn btn-outline-secondary btn-task" onclick="resetTask(${task.id})">
                                    <i class="fas fa-undo"></i>
                                </button>
                            `}
                        </div>
                    </div>
                `;
                tasksList.appendChild(taskElement);
            });
        }

        function completeTask(taskId) {
            const task = currentChecklist.tasks.find(t => t.id === taskId);
            task.status = 'completed';
            task.completedAt = new Date().toISOString();
            renderTasks();
            updateProgress();
            logAudit(`Completed task "${task.name}" in checklist "${currentChecklist.name}"`);
        }

        function ignoreTask(taskId) {
            const task = currentChecklist.tasks.find(t => t.id === taskId);
            task.status = 'ignored';
            renderTasks();
            updateProgress();
            logAudit(`Ignored task "${task.name}" in checklist "${currentChecklist.name}"`);
        }

        function resetTask(taskId) {
            const task = currentChecklist.tasks.find(t => t.id === taskId);
            task.status = 'pending';
            task.completedAt = null;
            renderTasks();
            updateProgress();
        }

        function updateProgress() {
            const completed = currentChecklist.tasks.filter(t => t.status === 'completed').length;
            const ignored = currentChecklist.tasks.filter(t => t.status === 'ignored').length;
            const total = currentChecklist.tasks.length;
            const percentage = Math.round((completed / total) * 100);
            document.getElementById('progressCircle').textContent = percentage + '%';
            document.getElementById('progressCircle').style.background = `conic-gradient(#28a745 ${percentage * 3.6}deg, #e9ecef 0deg)`;
            document.getElementById('progressCircle').style.color = percentage > 50 ? 'white' : 'black';
            document.getElementById('completedTasks').textContent = completed;
            document.getElementById('totalTasks').textContent = total;
            document.getElementById('ignoredTasks').textContent = ignored;
        }

        function saveProgress() {
            if (!currentChecklist) {
                alert('No active checklist to save');
                return;
            }
            const savedChecklists = JSON.parse(localStorage.getItem(`checklists_${currentUser.username}`) || '[]');
            const existingIndex = savedChecklists.findIndex(c => c.id === currentChecklist.id);
            if (existingIndex !== -1) {
                savedChecklists[existingIndex] = currentChecklist;
            } else {
                savedChecklists.push(currentChecklist);
            }
            localStorage.setItem(`checklists_${currentUser.username}`, JSON.stringify(savedChecklists));
            alert('Progress saved successfully!');
            loadSavedChecklists();
            logAudit(`Saved progress on checklist "${currentChecklist.name}"`);
        }

        function loadSavedChecklists() {
            const savedChecklists = JSON.parse(localStorage.getItem(`checklists_${currentUser.username}`) || '[]');
            const container = document.getElementById('savedChecklists');
            if (!container) return;
            if (savedChecklists.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No saved checklists</p>';
                return;
            }
            container.innerHTML = '';
            savedChecklists.forEach(checklist => {
                const completed = checklist.tasks.filter(t => t.status === 'completed').length;
                const percentage = Math.round((completed / checklist.tasks.length) * 100);
                const element = document.createElement('div');
                element.className = 'saved-checklist-item';
                element.innerHTML = `
                    <span>
                        <span class="fw-bold">${checklist.name}</span>
                        <span class="text-muted ms-1">(${checklist.license})</span>
                        <span class="badge bg-success ms-1">${percentage}%</span>
                    </span>
                    <button class="btn btn-outline-primary btn-sm" onclick="loadChecklist(${checklist.id})">
                        Load
                    </button>
                `;
                container.appendChild(element);
            });
        }

        function loadChecklist(checklistId) {
            const savedChecklists = JSON.parse(localStorage.getItem(`checklists_${currentUser.username}`) || '[]');
            const checklist = savedChecklists.find(c => c.id === checklistId);
            if (!checklist) {
                alert('Checklist not found');
                return;
            }
            currentChecklist = checklist;
            selectedLicense = checklist.license;
            document.getElementById('currentChecklistName').textContent = checklist.name;
            document.getElementById('currentLicense').textContent = checklist.license;
            document.getElementById('step4').style.display = 'block';
            renderTasks();
            updateProgress();
            document.getElementById('step4').scrollIntoView({ behavior: 'smooth' });
        }

        function resetChecklist() {
            if (confirm('Are you sure you want to start a new checklist? Unsaved progress will be lost.')) {
                selectedLicense = null;
                currentChecklist = null;
                document.querySelectorAll('.license-card').forEach(card => {
                    card.classList.remove('selected');
                });
                document.getElementById('checklistName').value = '';
                document.getElementById('step2').style.display = 'none';
                document.getElementById('step3').style.display = 'none';
                document.getElementById('step4').style.display = 'none';
                document.getElementById('step3-tasks-progress').style.display = 'none';
                document.getElementById('savedChecklistCollapse').classList.remove('show');
                document.getElementById('step1').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        }
        function logAudit(message) {
  const config = JSON.parse(localStorage.getItem("systemConfig")) || { auditLogs: true };
  if (!config.auditLogs) return;

  const currentUser = JSON.parse(localStorage.getItem("currentUser"));
  if (!currentUser) return;

  const logs = JSON.parse(localStorage.getItem("auditLogs")) || [];
  logs.push({
    user: currentUser.username,
    role: currentUser.role,
    message,
    time: new Date().toLocaleString()
  });
  localStorage.setItem("auditLogs", JSON.stringify(logs));
}
    </script>
</body>
</html>